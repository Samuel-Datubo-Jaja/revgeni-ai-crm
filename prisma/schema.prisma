generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Org {
  id                String          @id @default(cuid())
  name              String
  createdAt         DateTime        @default(now())
  companies         Company[]
  deals             Deal[]
  sequences         EmailSequence[]
  events             Event[]
  people            Person[]
  users             UserOrg[]
  userConnections    UserConnection[]
  companySequences  CompanySequence[]
}

model User {
  id        String    @id
  email     String    @unique
  createdAt DateTime  @default(now())
  orgs      UserOrg[]
  connections UserConnection[]
}

model UserOrg {
  id     String @id @default(cuid())
  userId String
  orgId  String
  role   String
  org    Org    @relation(fields: [orgId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@unique([userId, orgId])
}

model Company {
  id        String        @id @default(cuid())
  orgId     String
  name      String
  domain    String?
  industry  String?
  sizeBand  String?
  geography String?
  status    CompanyStatus @default(NEW)
  score     Int?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  org       Org           @relation(fields: [orgId], references: [id])
  deals     Deal[]
  events    Event[]
  people    Person[]
  assignedSequences CompanySequence[]

  @@unique([orgId, domain])
  @@index([orgId, status])
}

model Person {
  id        String   @id @default(cuid())
  orgId     String
  companyId String
  fullName  String
  title     String?
  email     String?
  phone     String?
  linkedin  String?
  createdAt DateTime @default(now())
  events    Event[]
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  org       Org      @relation(fields: [orgId], references: [id])

  @@index([orgId, companyId])
  @@map("people")
}

model Deal {
  id                 String   @id @default(cuid())
  orgId              String
  companyId          String
  name               String
  value              Float?
  stage              String
  expectedCloseDate  DateTime? 
  description        String?   
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  company            Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  org                Org      @relation(fields: [orgId], references: [id])
  events             Event[]

  @@index([orgId, stage])
  @@map("deals")
}

model Event {
  id        String   @id @default(cuid())
  orgId     String
  companyId String?
  personId  String?
  dealId    String?
  type      String
  summary   String?
  body      String?
  at        DateTime @default(now())
  company   Company? @relation(fields: [companyId], references: [id])
  deal      Deal?    @relation(fields: [dealId], references: [id])
  org       Org      @relation(fields: [orgId], references: [id])
  person    Person?  @relation(fields: [personId], references: [id])

  @@index([orgId, at])
}

model EmailSequence {
  id        String   @id @default(cuid())
  orgId     String
  name      String
  steps     Json
  fromName  String?
  fromEmail String?
  createdAt DateTime @default(now())
  org       Org      @relation(fields: [orgId], references: [id])
  assignments CompanySequence[]
}

model OutboxEmail {
  id          String   @id @default(cuid())
  orgId       String
  sequenceId  String
  companyId   String?
  personId    String?
  stepIndex   Int
  scheduledAt DateTime
  status      String
  providerId  String?
  error       String?
  createdAt   DateTime @default(now())

  @@index([orgId, scheduledAt, status])
}

model UserConnection {
  id                String   @id @default(cuid())
  userId            String
  orgId             String
  provider          String   // 'gmail', 'outlook', etc.
  nangoConnectionId String   // The UUID from Nango
  status            String   @default("active") // 'active', 'expired', 'revoked'
  email             String?  // The connected email address
  scopes            String[] // Granted permissions
  connectedAt       DateTime @default(now())
  lastUsedAt        DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  org  Org  @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([userId, provider])
  @@map("user_connections")
}

model CompanySequence {
  id          String   @id @default(cuid())
  orgId       String
  companyId   String
  sequenceId  String
  currentStep Int      @default(0)  
  status      String   @default("active") 
  startedAt   DateTime @default(now())
  nextSendAt  DateTime? 
  completedAt DateTime?
  
  company   Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sequence  EmailSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  org       Org           @relation(fields: [orgId], references: [id])

  @@unique([companyId, sequenceId]) 
  @@index([orgId, nextSendAt, status])
  @@map("company_sequences")
}

enum CompanyStatus {
  NEW
  QUALIFIED
  CONTACTED
  MEETING
  PROPOSAL
  WON
  LOST
}
